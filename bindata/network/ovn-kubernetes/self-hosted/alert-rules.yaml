apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: k8s
    role: alert-rules
  annotations:
    networkoperator.openshift.io/ignore-errors: ""
  name: master-rules
  namespace: openshift-ovn-kubernetes
spec:
  groups:
  - name: cluster-network-operator-master.rules
    rules:
    - record: cluster:ovnkube_master_egress_routing_via_host:max
      expr: max(ovnkube_master_egress_routing_via_host)
    # OVN kubernetes master functional alerts
    - alert: NoRunningOvnMaster
      annotations:
        summary: There is no running ovn-kubernetes master.
        runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-network-operator/NoRunningOvnMaster.md
        description: |
          Networking control plane is degraded. Networking configuration updates applied to the cluster will not be
          implemented while there are no OVN Kubernetes pods.
      expr: |
        absent(up{job="ovnkube-master", namespace="openshift-ovn-kubernetes"} == 1)
      for: 5m
      labels:
        severity: critical
    - alert: NoOvnMasterLeader
      annotations:
        summary: There is no ovn-kubernetes master leader.
        runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-network-operator/NoOvnMasterLeader.md
        description: |
          Networking control plane is degraded. Networking configuration updates applied to the cluster will not be
          implemented while there is no OVN Kubernetes leader. Existing workloads should continue to have connectivity.
          OVN-Kubernetes control plane is not functional.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        max(max_over_time(ovnkube_master_leader[5m])) == 0
      for: 10m
      labels:
        severity: critical
    - alert: V4SubnetAllocationThresholdExceeded
      annotations:
        summary: More than 80% of v4 subnets available to assign to the nodes are allocated. Current v4 subnet allocation percentage is {{"{{"}} $value {{"}}"}}.
        runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-network-operator/V4SubnetAllocationThresholdExceeded.md
        description: More than 80% of IPv4 subnets are used. Insufficient IPv4 subnets could degrade provisioning of workloads.
      expr: ovnkube_master_allocated_v4_host_subnets/ovnkube_master_num_v4_host_subnets * 100 > 80
      for: 10m
      labels:
        severity: warning
    - alert: V6SubnetAllocationThresholdExceeded
      annotations:
        summary: More than 80% of the v6 subnets available to assign to the nodes are allocated. Current v6 subnet allocation percentage is {{"{{"}} $value {{"}}"}}.
        description: More than 80% of IPv6 subnets are used. Insufficient IPv6 subnets could degrade provisioning of workloads.
      expr: ovnkube_master_allocated_v6_host_subnets/ovnkube_master_num_v6_host_subnets * 100 > 80
      for: 10m
      labels:
        severity: warning
    # OVN northbound and southbound databases functional alerts
    - alert: NorthboundStale
      annotations:
        summary: ovn-kubernetes has not written anything to the northbound database for too long.
        runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-network-operator/NorthboundStaleAlert.md
        description: |
          Networking control plane is degraded. Networking configuration updates applied to the cluster will not be
          implemented. Existing workloads should continue to have connectivity. OVN-Kubernetes control plane and/or
          OVN northbound database may not be functional.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        time() - max_over_time(ovnkube_master_nb_e2e_timestamp[5m]) > 120
      for: 10m
      labels:
        severity: warning
    - alert: SouthboundStale
      annotations:
        summary: ovn-northd has not successfully synced any changes to the southbound DB for too long.
        runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-network-operator/SouthboundStaleAlert.md
        description: |
          Networking control plane is degraded. Networking configuration updates may not be applied to the cluster or
          taking a long time to apply. This usually means there is a large load on OVN component 'northd' or it is not
          functioning.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        max_over_time(ovnkube_master_nb_e2e_timestamp[5m]) - max_over_time(ovnkube_master_sb_e2e_timestamp[5m]) > 120
      for: 10m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseClusterIDError
      annotations:
        summary: Multiple OVN northbound database cluster IDs exist.
        description: More than one OVN northbound database cluster ID indicates degraded OVN database high availability
          and possible database split brain.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count(count(min_over_time(ovn_db_cluster_id{db_name="OVN_Northbound"}[5m])) by (cluster_id)) > 1
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseClusterIDError
      annotations:
        summary: Multiple OVN southbound database cluster IDs exist.
        description: More than one OVN southbound database cluster ID indicates degraded OVN database high availability
          and possible database split brain.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count(count(min_over_time(ovn_db_cluster_id{db_name="OVN_Southbound"}[5m])) by (cluster_id)) > 1
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseTermLag
      annotations:
        summary: OVN northbound databases RAFT term have not been equal for a period of time.
        description: OVN northbound database(s) RAFT term have not been equal which may indicate degraded OVN database high availability.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        max(max_over_time(ovn_db_cluster_term{db_name="OVN_Northbound"}[5m])) - min(max_over_time(ovn_db_cluster_term{db_name="OVN_Northbound"}[5m])) > 0
      for: 25m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseTermLag
      annotations:
        summary: OVN southbound databases RAFT term have not been equal for a period of time.
        description: OVN southbound database(s) RAFT term have not been equal which may indicate degraded OVN database high availability.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        max(max_over_time(ovn_db_cluster_term{db_name="OVN_Southbound"}[5m])) - min(max_over_time(ovn_db_cluster_term{db_name="OVN_Southbound"}[5m])) > 0
      for: 25m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseLeaderError
      annotations:
        summary: OVN northbound database(s) have no RAFT leader
        description: OVN northbound database(s) have no RAFT leader. Networking control plane is degraded.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count(max_over_time(ovn_db_cluster_server_role{db_name="OVN_Northbound", server_role="leader"}[5m])) == 0
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseLeaderError
      annotations:
        summary: OVN southbound database(s) have no RAFT leader
        description: OVN southbound database(s) have no leader. Networking control plane is degraded.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count(max_over_time(ovn_db_cluster_server_role{db_name="OVN_Southbound", server_role="leader"}[5m])) == 0
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseMultipleLeadersError
      annotations:
        summary: OVN northbound database(s) have multiple RAFT leaders
        description: OVN northbound database(s) have multiple RAFT leaders which may indicate degraded OVN database high availability.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count by (leader) (min_over_time(ovn_db_cluster_server_role{db_name="OVN_Northbound", server_role="leader"}[1m])) > 1
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseMultipleLeadersError
      annotations:
        summary: OVN southbound database(s) have multiple RAFT leaders
        description: OVN southbound database(s) have multiple RAFT leaders which may indicate degraded OVN database high availability.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count by (leader) (min_over_time(ovn_db_cluster_server_role{db_name="OVN_Southbound", server_role="leader"}[1m])) > 1
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseClusterMemberError
      annotations:
        summary: OVN northbound database server(s) has not been a member of the databases high availability for a period of time.
        description: OVN northbound database server(s) has not been a RAFT cluster member for a period of time which may indicate
          degraded OVN database high availability cluster.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count(max_over_time(ovn_db_cluster_server_status{db_name="OVN_Northbound", server_status="cluster member"}[5m])) 
        != sum(max_over_time(kube_node_role{role="master"}[5m]))
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseClusterMemberError
      annotations:
        summary: OVN southbound database server(s) has not been a member of the databases high availability for a period of time.
        description: OVN southbound database server(s) has not been a RAFT cluster member for a period of time which may indicate
          degraded OVN database high availability.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        count(max_over_time(ovn_db_cluster_server_status{db_name="OVN_Southbound", server_status="cluster member"}[5m])) 
        != sum(max_over_time(kube_node_role{role="master"}[5m]))
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseInboundConnectionError
      annotations:
        summary: OVN northbound database server(s) is experiencing inbound RAFT connectivity errors.
        description: OVN northbound database server(s) is experiencing inbound RAFT connectivity errors which may indicate degraded OVN
          database high availability.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        # ..error_total is set to zero when error resolves itself
        min_over_time(ovn_db_cluster_inbound_connections_error_total{db_name="OVN_Northbound"}[5m]) > 0
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseInboundConnectionError
      annotations:
        summary: OVN southbound database server(s) is experiencing inbound RAFT connectivity errors.
        description: OVN southbound database server(s) is experiencing inbound RAFT connectivity errors which may indicate degraded OVN
          database high availability.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        # ..error_total is set to zero when error resolves itself
        min_over_time(ovn_db_cluster_inbound_connections_error_total{db_name="OVN_Southbound"}[5m]) > 0
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseOutboundConnectionError
      annotations:
        summary: OVN northbound database server(s) is experiencing outbound RAFT connectivity errors.
        description: OVN northbound database server(s) outbound RAFT connectivity errors may indicate degraded OVN
          database high availability.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        # ..error_total is set to zero when error resolves itself
        min_over_time(ovn_db_cluster_outbound_connections_error_total{db_name="OVN_Northbound"}[5m]) > 0
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseOutboundConnectionError
      annotations:
        summary: OVN southbound database server(s) is experiencing outbound RAFT connectivity errors.
        description: OVN southbound database server(s) outbound RAFT connectivity errors which may indicate degraded OVN
          database high availability.
      expr: |
        # Without min_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        # ..error_total is set to zero when error resolves itself
        min_over_time(ovn_db_cluster_outbound_connections_error_total{db_name="OVN_Southbound"}[5m]) > 0
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseInboundConnectionMissing
      annotations:
        summary: OVN northbound database server(s) do not have expected number of inbound RAFT connections.
        description: OVN northbound database server(s) do not have expected number of inbound connections for a RAFT cluster
          which may indicate degraded OVN database high availability.
      expr: |
        # Expected sum of inbound connections is number of control plane nodes * number of control plane nodes minus one
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        sum(max_over_time(ovn_db_cluster_inbound_connections_total{db_name="OVN_Northbound"}[5m]))
        != count(max_over_time(kube_node_role{role="master"}[5m])) * (count(max_over_time(kube_node_role{role="master"}[5m]))-1)
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseInboundConnectionMissing
      annotations:
        summary: OVN southbound database server(s) do not have expected number of inbound RAFT connections.
        description: OVN southbound database server(s) do not have expected number of inbound connections for a RAFT cluster
          which may indicate degraded OVN database high availability.
      expr: |
        # Expected sum of inbound connections is number of control plane nodes * number of control plane nodes minus one
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        sum(max_over_time(ovn_db_cluster_inbound_connections_total{db_name="OVN_Southbound"}[5m]))
        != count(max_over_time(kube_node_role{role="master"}[5m])) * (count(max_over_time(kube_node_role{role="master"}[5m]))-1)
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesNorthboundDatabaseOutboundConnectionMissing
      annotations:
        summary: OVN northbound database server(s) do not have expected number of outbound RAFT connections.
        description: OVN northbound database server(s) do not have expected number of outbound connections for a RAFT cluster
          which may indicate degraded OVN database high availability.
      expr: |
        # Expected sum of outbound connections is number of control plane nodes * number of control plane nodes minus one
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        sum(max_over_time(ovn_db_cluster_outbound_connections_total{db_name="OVN_Northbound"}[5m]))
        != count(max_over_time(kube_node_role{role="master"}[5m])) * (count(max_over_time(kube_node_role{role="master"}[5m]))-1)
      for: 5m
      labels:
        severity: warning
    - alert: OVNKubernetesSouthboundDatabaseOutboundConnectionMissing
      annotations:
        summary: OVN southbound database server(s) do not have expected number of outbound RAFT connections.
        description: OVN southbound database server(s) do not have expected number of outbound connections for a RAFT cluster
          which may indicate degraded OVN database high availability.
      expr: |
        # Expected sum of outbound connections is number of control plane nodes * number of control plane nodes minus one
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        sum(max_over_time(ovn_db_cluster_outbound_connections_total{db_name="OVN_Southbound"}[5m]))
        != count(max_over_time(kube_node_role{role="master"}[5m])) * (count(max_over_time(kube_node_role{role="master"}[5m]))-1)
      for: 5m
      labels:
        severity: warning
    # OVN northd functional alerts
    - alert: OVNKubernetesNorthdInactive
      annotations:
        summary: No OVN northd is active. Networking is degraded.
        description: No OVN northd is available within the high availability set. Networking control plane is degraded.
      expr: |
        # Without max_over_time, failed scrapes could create false negatives, see
        # https://www.robustperception.io/alerting-on-gauges-in-prometheus-2-0 for details.
        sum(max_over_time(ovn_northd_status[5m])) == 0
      for: 5m
      labels:
        severity: critical
    # OVN kubernetes node functional alerts
    - alert: NodeWithoutOVNKubeNodePodRunning
      annotations:
        summary: All Linux nodes should be running an ovnkube-node pod, {{"{{"}} $labels.node {{"}}"}} is not.
        runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-network-operator/NodeWithoutOVNKubeNodePodRunning.md
        description: |
          Networking is degraded on nodes that do not have a functioning ovnkube-node pod. Existing workloads on the
          node may continue to have connectivity but any changes to the networking control plane will not be implemented.
      expr: |
        (kube_node_info unless on(node) (kube_pod_info{namespace="openshift-ovn-kubernetes",pod=~"ovnkube-node.*"}
        or kube_node_labels{label_kubernetes_io_os="windows"})) > 0
      for: 20m
      labels:
        severity: warning
    - alert: OVNKubernetesNodePodAddError
      annotations:
        summary: OVN Kubernetes is experiencing pod creation errors at an elevated rate.
        description: OVN Kubernetes experiences pod creation errors at an elevated rate for the last 5 minutes. The
          pods will be retried.
      expr: |
        (sum(rate(ovnkube_node_cni_request_duration_seconds_bucket{command="ADD",err="true"}[5m]))
          /
        sum(rate(ovnkube_node_cni_request_duration_seconds_bucket{command="ADD"}[5m])))
        > 0.1
      for: 15m
      labels:
        severity: warning
    - alert: OVNKubernetesNodePodDeleteError
      annotations:
        summary: OVN Kubernetes experiencing pod deletion errors at an elevated rate.
        description: OVN Kubernetes is experiences pod creation errors at an elevated rate for the last 5 minutes. The
          pods will be retried.
      expr: |
        (sum(rate(ovnkube_node_cni_request_duration_seconds_bucket{command="DEL",err="true"}[5m]))
          /
        sum(rate(ovnkube_node_cni_request_duration_seconds_bucket{command="DEL"}[5m])))
        > 0.1
      for: 15m
      labels:
        severity: warning
